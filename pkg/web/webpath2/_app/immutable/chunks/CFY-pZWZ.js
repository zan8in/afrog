import{aa as Lt,ab as Tt,Z as G,a6 as rt,j as n,W as a,ac as dt,ad as ot}from"./DP9-rN22.js";import{a as R}from"./rPupsha6.js";const le=Tt,pe=Lt,gt="afrog.strategy.list",mt="afrog.strategy.active",j={performance:{rateLimit:150,concurrency:25,smart:!1,timeout:50,retries:1},http:{proxy:"",sort:"",headers:[]},oob:{adapter:"",rateLimit:25,concurrency:25}};function Q(){return new Date().toISOString()}function W(){const e=globalThis.crypto?.randomUUID?.();if(e&&typeof e=="string")return e;const s=Date.now(),t=Math.random().toString(36).slice(2,8);return`${s}-${t}`}function lt(e){const s=new dt;let t=!1;for(const i of e)(!i.id||s.has(i.id))&&(i.id=W(),t=!0),s.add(i.id);return{list:e,changed:t}}function Dt(){try{const e=localStorage.getItem(gt);if(!e)return[];const s=JSON.parse(e);return Array.isArray(s)?s:[]}catch{return[]}}function $(e){try{localStorage.setItem(gt,JSON.stringify(e))}catch{return}}function Ot(){try{return localStorage.getItem(mt)}catch{return null}}function it(e){try{localStorage.setItem(mt,e)}catch{return}}function Mt(e){return JSON.parse(JSON.stringify(e))}function at(e){const s=j;return{performance:{...s.performance,...e.performance||{}},http:{...s.http,...e.http||{}},oob:{...s.oob,...e.oob||{}}}}function ct(e){const s={},t=e.performance,i={};t.smart!==j.performance.smart&&(i.smart=t.smart),t.timeout!==j.performance.timeout&&(i.timeout=t.timeout),t.retries!==j.performance.retries&&(i.retries=t.retries),t.smart||(t.rateLimit!==j.performance.rateLimit&&(i.rateLimit=t.rateLimit),t.concurrency!==j.performance.concurrency&&(i.concurrency=t.concurrency)),Object.keys(i).length&&(s.performance=i);const r=e.http,f={};(r.proxy||"")!==j.http.proxy&&(f.proxy=r.proxy||""),(r.sort||"")!==j.http.sort&&(f.sort=r.sort||"");const h=(r.headers||[]).filter(b=>b&&b.trim().length>0);h.length&&(f.headers=h),Object.keys(f).length&&(s.http=f);const T=e.oob,y={};return(T.adapter||"")!==""&&(y.adapter=T.adapter||""),(y.adapter||"").trim().length>0&&(T.rateLimit!==j.oob.rateLimit&&(y.rateLimit=T.rateLimit),T.concurrency!==j.oob.concurrency&&(y.concurrency=T.concurrency)),Object.keys(y).length&&(s.oob=y),s}function st(e){const s=/\s/.test(e),t=/['"]/.test(e);return!s&&!t?e:`'${e.replace(/'/g,"'\\''")}'`}function ut(e){const s=at(e),t=ct(s),i=[];if(t.performance?.smart&&i.push("--smart"),typeof t.performance?.timeout=="number"&&i.push("--timeout",String(t.performance.timeout)),typeof t.performance?.retries=="number"&&i.push("--retries",String(t.performance.retries)),typeof t.performance?.rateLimit=="number"&&i.push("-rl",String(t.performance.rateLimit)),typeof t.performance?.concurrency=="number"&&i.push("-c",String(t.performance.concurrency)),t.http?.proxy&&t.http.proxy.trim().length&&i.push("--proxy",st(t.http.proxy.trim())),t.http?.sort&&t.http.sort.length&&i.push("--sort",t.http.sort),t.http?.headers&&t.http.headers.length)for(const r of t.http.headers)i.push("-H",st(r));return t.oob?.adapter&&t.oob.adapter.trim().length&&(i.push("--oob",st(t.oob.adapter.trim())),typeof t.oob.rateLimit=="number"&&i.push("-orl",String(t.oob.rateLimit)),typeof t.oob.concurrency=="number"&&i.push("-oc",String(t.oob.concurrency))),i}function ht(e){return["afrog",...ut(e)].join(" ")}function Et(){const e=Q(),s={},t={id:W(),name:"默认策略",isDefault:!0,createdAt:e,updatedAt:e,payload:s},i={id:W(),name:"测试PoC策略",createdAt:e,updatedAt:e,payload:{performance:{rateLimit:50,concurrency:5,retries:2}}},r={id:W(),name:"高危扫描策略",createdAt:e,updatedAt:e,payload:{performance:{smart:!0}}};return[t,i,r]}let m=G(rt([])),H=G(null),pt=!1;function xt(){if(pt)return;pt=!0;const e=Dt();a(m,Array.isArray(e)?e:[],!0);{const{list:t,changed:i}=lt(n(m));a(m,t,!0),i&&$(n(m))}if(n(m).length===0){a(m,Et(),!0);const{list:t}=lt(n(m));a(m,t,!0),$(n(m))}const s=Ot();a(H,s&&n(m).some(t=>t.id===s)?s:n(m)[0]?.id||null,!0),n(H)&&it(n(H))}function Y(){return n(m).find(e=>e.id===n(H))||null}function yt(e){a(H,e,!0),it(e)}function _t(e){const s=Q(),t={id:W(),name:e?.trim().length?e.trim():"新策略",createdAt:s,updatedAt:s,payload:{}};return a(m,[t,...n(m)],!0),yt(t.id),$(n(m)),t.id}function Pt(e){a(m,n(m).filter(s=>s.id!==e),!0),n(H)===e&&(a(H,n(m)[0]?.id||null,!0),n(H)&&it(n(H))),$(n(m))}function Ct(e,s){a(m,n(m).map(t=>t.id===e?{...t,name:s,updatedAt:Q()}:t),!0),$(n(m))}function qt(e,s){const t=n(m).find(f=>f.id===e);if(!t)return null;const i=Q(),r={id:W(),name:s?.trim().length?s.trim():`${t.name} 副本`,isDefault:!1,createdAt:i,updatedAt:i,payload:Mt(t.payload)};return a(m,[r,...n(m)],!0),$(n(m)),r.id}function Jt(e){a(m,n(m).map(s=>({...s,isDefault:s.id===e})),!0),$(n(m))}function jt(e){const s=Y();if(!s)return;const t=ct(e),i={...s,payload:t,updatedAt:Q()};a(m,n(m).map(r=>r.id===s.id?i:r),!0),$(n(m))}function Rt(){const s=Y()?.payload||{};return at(s)}function Ht(){const e=Y();return ut(e?.payload||{})}function $t(){const e=Y();return ht(e?.payload||{})}const ft={get strategies(){return n(m)},get activeId(){return n(H)},load:xt,setActive:yt,create:_t,remove:Pt,rename:Ct,duplicate:qt,setDefault:Jt,getActive:Y,getActiveMerged:Rt,saveActive:jt,toActiveArgs:Ht,toActiveCommand:$t,mergeWithBaseline:at,diffAgainstBaseline:ct,toArgs:ut,toCommandString:ht,BASELINE:j},Bt="afrog_db",Ft=1,B="logs",F="hits";let I=null;async function Z(){return I||new Promise((e,s)=>{const t=indexedDB.open(Bt,Ft);t.onerror=()=>s(t.error),t.onsuccess=()=>{I=t.result,e(I)},t.onupgradeneeded=i=>{const r=i.target.result;r.objectStoreNames.contains(B)||r.createObjectStore(B),r.objectStoreNames.contains(F)||r.createObjectStore(F)}})}async function Ut(e,s){const t=await Z();if(t)return new Promise((i,r)=>{const h=t.transaction(B,"readwrite").objectStore(B),T=JSON.parse(JSON.stringify(s||[])),y=h.put(T,e);y.onsuccess=()=>i(),y.onerror=()=>r(y.error)})}async function Gt(e){const s=await Z();return s?new Promise(t=>{const f=s.transaction(B,"readonly").objectStore(B).get(e);f.onsuccess=()=>t(f.result||[]),f.onerror=()=>t([])}):[]}async function Vt(e,s){const t=await Z();if(t)return new Promise((i,r)=>{const h=t.transaction(F,"readwrite").objectStore(F),T=JSON.parse(JSON.stringify(s||[])),y=h.put(T,e);y.onsuccess=()=>i(),y.onerror=()=>r(y.error)})}async function Wt(e){const s=await Z();return s?new Promise(t=>{const f=s.transaction(F,"readonly").objectStore(F).get(e);f.onsuccess=()=>t(f.result||[]),f.onerror=()=>t([])}):[]}async function zt(e){const s=await Z();if(!s)return;const t=s.transaction([B,F],"readwrite");t.objectStore(B).delete(e),t.objectStore(F).delete(e)}const tt=e=>new Promise(s=>setTimeout(s,e)),St="afrog_scan_tasks",k={};function bt(e){k[e]&&clearTimeout(k[e]),k[e]=setTimeout(()=>{Ut(e,n(A)[e]),Vt(e,n(q)[e]),N(),delete k[e]},2e3)}function N(){try{const e=JSON.stringify(n(o));localStorage.setItem(St,e)}catch(e){console.error("Failed to persist tasks",e)}}async function Kt(){try{const e=localStorage.getItem(St);if(e){const s=JSON.parse(e);if(Array.isArray(s)){a(o,s.map(t=>({...t,status:t.status==="running"||t.status==="starting"?"failed":t.status})),!0);for(const t of n(o))try{const i=await Gt(t.id);Array.isArray(i)&&a(A,{...n(A),[t.id]:i},!0);const r=await Wt(t.id);Array.isArray(r)&&a(q,{...n(q),[t.id]:r},!0)}catch(i){console.error("Failed to restore logs for task",t.id,i)}n(o).length>0&&!n(U)&&(a(U,n(o)[0].id,!0),a(X,!0))}}}catch(e){console.error("Failed to restore tasks",e)}try{const e=await R.listInstances(),s=new dt;if(e?.success&&e.data?.instances)for(const i of e.data.instances)i.active_task_ids&&i.active_task_ids.forEach(r=>s.add(String(r)));let t=[...n(o)];for(const i of s){let r=t.find(f=>f.serverTaskId===i||f.id===i);if(r)r.status="running";else{const f=i;r={id:f,serverTaskId:i,name:`Remote Task ${i}`,status:"running",progress:{total:0,finished:0,hits:0,percent:0,rate:0,elapsedMs:0},severityStats:{critical:0,high:0,medium:0,low:0,info:0},createdAt:new ot().toISOString(),options:{...D},pocs:[]},t=[r,...t],a(A,{...n(A),[f]:[]},!0),a(q,{...n(q),[f]:[]},!0)}At(r.id,i)}a(o,t,!0),N()}catch(e){console.error("Failed to sync with backend",e)}}let X=G(!1),vt=G(.33),o=G(rt([])),U=G(null);const et={},O={},_={},nt={};let A=G(rt({})),q=G(rt({}));const D={concurrency:10,rate:100,timeout:1e4,followRedirects:!0,allowIntranet:!1,oob:!1};function Qt(e){a(X,e,!0)}function Yt(e){const s=Math.max(.3,Math.min(1,e));a(vt,s,!0)}function Zt(){return n(o).find(e=>e.id===n(U))||null}function Xt(e,s){const t=String(Date.now()),i={id:t,name:e??"New Scan",status:"idle",progress:{total:0,finished:0,hits:0,percent:0,rate:0,elapsedMs:0},severityStats:{critical:0,high:0,medium:0,low:0,info:0},createdAt:new ot().toISOString(),options:{...D},pocs:[],targets:s||[]};return a(o,[i,...n(o)],!0),a(U,t,!0),a(X,!0),a(A,{...n(A),[t]:[]},!0),a(q,{...n(q),[t]:[]},!0),N(),t}function It(e){const s=n(o).find(t=>t.id===e);s&&(s.status!=="running"&&s.status!=="starting"||(s.status="paused",a(o,n(o).map(t=>t.id===e?s:t),!0),N()))}function kt(e){const s=n(o).find(t=>t.id===e);s&&s.status==="paused"&&(s.status="running",a(o,n(o).map(t=>t.id===e?s:t),!0),N())}function wt(e){const s=n(o).find(f=>f.id===e);if(!s||s.status==="cancelled"||s.status==="completed"||s.status==="failed")return;s.status="cancelled",a(o,n(o).map(f=>f.id===e?s:f),!0),N();const t=et[e];t&&(clearInterval(t),delete et[e]);const i=O[e];if(i){try{i.abort()}catch{}delete O[e]}const r=_[e];if(r){try{r.close()}catch{}delete _[e]}try{R.stopScan(s.serverTaskId||e).catch(()=>{})}catch{}}function te(e){if(n(o).find(t=>t.id===e)){try{wt(e)}catch{}delete n(A)[e],delete n(q)[e],zt(e);try{const t=et[e];t&&clearInterval(t),delete et[e]}catch{}try{O[e]?.abort()}catch{}delete O[e];try{_[e]?.close()}catch{}delete _[e],a(o,n(o).filter(t=>t.id!==e),!0),n(U)===e&&a(U,n(o)[0]?.id||"",!0),N()}}function ee(e){a(U,e,!0)}async function Nt(e,s,t=1e3,i){const r=n(o).find(f=>f.id===e);if(r&&!(r.status==="starting"||r.status==="running")&&!nt[e]){nt[e]=!0;try{const f=s[0]||"";r.target=f,r.targets=s.slice(),r.name=i||f||r.name,r.progress={total:t,finished:0,hits:r.progress.hits||0,percent:0,rate:0,elapsedMs:0},r.status="starting",r.startedAt=new ot().toISOString(),a(o,n(o).map(h=>h.id===e?r:h),!0),N(),a(A,{...n(A),[e]:n(A)[e]||[]},!0),a(U,e,!0),a(X,!0),r.poc&&x(e,{ts:Date.now(),type:"info",text:`使用 PoC ${r.poc.name}`}),r.options&&x(e,{ts:Date.now(),type:"debug",text:`并发 ${r.options.concurrency} · 速率 ${r.options.rate}/s · 超时 ${r.options.timeout}ms`});try{const h={targets:s.slice(),enable_stream:!0},T=(r.pocs||[]).map(b=>b.id);T.length?h.poc_ids=T:h.poc_source="default";try{const b=ft.getActiveMerged(),L=ft.diffAgainstBaseline(b),l=L?.performance||{},S=L?.http||{},M=L?.oob||{};l.smart&&(h.smart=!0),typeof l.timeout=="number"&&(h.timeout=l.timeout),typeof l.retries=="number"&&(h.retries=l.retries),typeof l.rateLimit=="number"&&(h.rate_limit=l.rateLimit),typeof l.concurrency=="number"&&(h.concurrency=l.concurrency),(S.proxy||"").trim().length&&(h.proxy=(S.proxy||"").trim()),S.sort&&S.sort.length&&(h.sort=S.sort),S.headers&&S.headers.length&&(h.headers=S.headers.slice()),(M.adapter||"").trim().length&&(h.enable_oob=!0,h.oob=(M.adapter||"").trim(),typeof M.rateLimit=="number"&&(h.oob_rate_limit=M.rateLimit),typeof M.concurrency=="number"&&(h.oob_concurrency=M.concurrency))}catch{}let y=i;if(!y){x(e,{ts:Date.now(),type:"info",text:"Loading..."});try{const b=await R.createScan(h),L=n(A)[e]||[];if(L.length>0&&L[L.length-1].text==="Loading..."&&a(A,{...n(A),[e]:L.slice(0,-1)},!0),b.success&&b.data){y=b.data.taskId;const l=b.data.scanInfo;l&&(r.scanInfo=l,x(e,{ts:Date.now(),type:"info",text:"Scan Started",data:l}))}else throw new Error(b.message||"Unknown error")}catch(b){const L=n(A)[e]||[];L.length>0&&L[L.length-1].text==="Loading..."&&a(A,{...n(A),[e]:L.slice(0,-1)},!0);const l=b instanceof Error?b.message:String(b||"");x(e,{ts:Date.now(),type:"error",text:`Failed to create scan: ${l}`}),r.status="failed",a(o,n(o).map(S=>S.id===e?r:S),!0),N();return}}r.serverTaskId=y;try{const b=await R.getServerInfo();r.serverBaseUrl=R.getBaseUrl(),r.serverInstanceId=String(b?.data?.instance_id||r.serverInstanceId||"")}catch{}for(a(o,n(o).map(b=>b.id===e?r:b),!0),N();;){const b=new AbortController;O[e]=b;let L;try{L=await R.openScanEvents(y,{signal:b.signal})}catch(c){console.error("Scan events probe failed",c);return}if(String(L.headers?.get("content-type")||"").toLowerCase().includes("text/event-stream")){b.abort(),delete O[e];const c=R.openScanEventsSSE(y);_[e]=c;const u=V=>{try{const d=JSON.parse(String(V.data||"{}"));r.progress.finished=Number(d.finished??r.progress.finished),r.progress.total=Number(d.total??r.progress.total);const g=Math.floor((Number(d.finished??r.progress.finished)||0)/Math.max(1,Number(d.total??r.progress.total))*100);r.progress.percent=Number(d.percent??g),r.progress.rate=Number(d.rate??r.progress.rate),r.progress.elapsedMs=Number(d.elapsedMs??r.progress.elapsedMs),a(o,n(o).map(w=>w.id===e?r:w),!0)}catch{}},v=V=>{try{const d=JSON.parse(String(V.data||"{}")),g=String(d.status||"").toLowerCase();if(g){const w=r.status;if(r.status=["starting","running","paused","completed","failed","cancelled"].includes(g)?g:r.status,r.status==="completed"&&(r.progress.percent=100,r.progress.total>0&&(r.progress.finished=r.progress.total),x(e,{ts:Date.now(),type:"info",text:"Scan Completed",data:{severityStats:{...r.severityStats},total:r.progress.total,finished:r.progress.finished,duration:Date.now()-new Date(r.startedAt||r.createdAt).getTime()}})),a(o,n(o).map(E=>E.id===e?r:E),!0),w!==r.status&&N(),g==="completed"||g==="failed"||g==="cancelled"){try{O[e]?.abort()}catch{}_[e]?.close(),delete _[e],delete O[e]}}}catch{}},C=V=>{try{const d=JSON.parse(String(V.data||"{}")),g=String(d.severity||"info");r.severityStats[g]=(r.severityStats[g]||0)+1;const w=(r.progress.hits||0)+1;x(e,{ts:Date.now(),type:"hit",text:String(d.message||"命中"),severity:g,pocName:String(d.poc?.name||r.poc?.name||""),url:String(d.target||r.target||""),label:"HTTP",seq:w}),K(e,{ts:Date.now(),severity:g,target:String(d.target||r.target||""),pocId:String(d.poc?.id||r.poc?.id||""),pocName:String(d.poc?.name||r.poc?.name||""),message:String(d.message||"命中"),seq:w}),r.progress.hits=w,a(o,n(o).map(E=>E.id===e?r:E),!0)}catch{}};c.addEventListener("progress",u),c.addEventListener("status",v),c.addEventListener("result",C),c.onerror=()=>{try{_[e]?.close()}catch{}delete _[e],setTimeout(async()=>{["completed","failed","cancelled"].includes(r.status)||Nt(e,r.targets||[],r.progress.total||1e3)},1500)};return}const S=L.body?.getReader();if(!S){await tt(1e3);continue}const M=new TextDecoder;let J="",P=!1;const p=()=>{let c=0,u=0,v=-1;for(;c<J.length;){const C=J[c];if(C==="{")u===0&&(v=c),u++;else if(C==="}"&&(u--,u===0&&v>=0)){const V=J.slice(v,c+1).trim();try{const d=JSON.parse(V);if(d&&(d.percent!==void 0||d.finished!==void 0||d.total!==void 0)){const g=d||{};r.progress.finished=Number(g.finished??r.progress.finished),r.progress.total=Number(g.total??r.progress.total);const w=Math.floor((Number(g.finished??r.progress.finished)||0)/Math.max(1,Number(g.total??r.progress.total))*100);r.progress.percent=Number(g.percent??w),r.progress.rate=Number(g.rate??r.progress.rate),r.progress.elapsedMs=Number(g.elapsedMs??r.progress.elapsedMs),a(o,n(o).map(E=>E.id===e?r:E),!0)}else if(d&&(d.severity!==void 0||d.poc!==void 0||d.target!==void 0)){const g=d||{},w=String(g.severity||"info");r.severityStats[w]=(r.severityStats[w]||0)+1;const E=(r.progress.hits||0)+1;x(e,{ts:Date.now(),type:"hit",text:String(g.message||"命中"),severity:w,pocName:String(g.poc?.name||r.poc?.name||""),url:String(g.target||r.target||""),label:"HTTP",seq:E}),K(e,{ts:Date.now(),severity:w,target:String(g.target||r.target||""),pocId:String(g.poc?.id||r.poc?.id||""),pocName:String(g.poc?.name||r.poc?.name||""),message:String(g.message||"命中"),seq:E}),r.progress.hits=E,a(o,n(o).map(z=>z.id===e?r:z),!0)}else if(d&&d.status!==void 0){const w=String((d||{}).status||"").toLowerCase();if(w){const E=r.status;if(r.status=["starting","running","paused","completed","failed","cancelled"].includes(w)?w:r.status,r.status==="completed"&&(r.progress.percent=100,r.progress.total>0&&(r.progress.finished=r.progress.total)),a(o,n(o).map(z=>z.id===e?r:z),!0),E!==r.status&&N(),w==="completed"||w==="failed"||w==="cancelled"){try{O[e]?.abort()}catch{}delete O[e]}}}else if(d&&d.error!==void 0){const g=d||{};x(e,{ts:Date.now(),type:"error",text:String(g.message||"")}),r.status="failed",a(o,n(o).map(w=>w.id===e?r:w),!0),N()}}catch{}J=J.slice(c+1),c=-1,v=-1,u=0}c++}};for(;;){const{value:c,done:u}=await S.read();if(u){P=!0;break}J+=M.decode(c,{stream:!0}),p()}if(["completed","failed","cancelled"].includes(r.status))break;if(P){let c=null;try{const u=await R.getScanStatus(y);c=String(u?.data?.status||"")}catch{}if(c==="completed"||c==="failed"||c==="cancelled"){r.status=c||r.status,r.status==="completed"&&(r.progress.percent=100,r.progress.total>0&&(r.progress.finished=r.progress.total)),a(o,n(o).map(u=>u.id===e?r:u),!0),N();break}await tt(1500);continue}break}}catch(h){const T=h instanceof Error?h.message:"";r.status="failed",a(o,n(o).map(y=>y.id===e?r:y),!0),N(),x(e,{ts:Date.now(),type:"error",text:T?`连接扫描事件失败: ${T}`:"连接扫描事件失败"})}}finally{nt[e]=!1}}}function re(e,s){const t=n(o).find(r=>r.id===e);if(!t)return;const i={...t.options||D,...s};t.options=i,a(o,n(o).map(r=>r.id===e?t:r),!0),N()}function se(e,s){const t=n(o).find(i=>i.id===e);t&&(t.poc=s,a(o,n(o).map(i=>i.id===e?t:i),!0),N())}function ne(e,s){const t=n(o).find(r=>r.id===e);if(!t)return;const i=Array.isArray(t.pocs)?t.pocs.slice():[];i.find(r=>r.id===s.id)||i.push(s),t.pocs=i,a(o,n(o).map(r=>r.id===e?t:r),!0),N()}function oe(e,s){const t=n(o).find(i=>i.id===e);t&&(t.pocs=(t.pocs||[]).filter(i=>i.id!==s),a(o,n(o).map(i=>i.id===e?t:i),!0),N())}function ie(e){const s=n(o).find(t=>t.id===e);s&&(s.pocs=[],a(o,n(o).map(t=>t.id===e?s:t),!0),N())}function ae(e){D.concurrency=e.concurrency??D.concurrency,D.rate=e.rate??D.rate,D.timeout=e.timeout??D.timeout,D.followRedirects=e.followRedirects??D.followRedirects,D.allowIntranet=e.allowIntranet??D.allowIntranet,D.oob=e.oob??D.oob,a(o,n(o).map(s=>({...s,options:{...s.options||D,...e}})),!0),N()}function x(e,s){const t=(n(A)[e]||[]).slice();t.push(s),a(A,{...n(A),[e]:t.slice(-1e3)},!0),bt(e)}function K(e,s){const t=(n(q)[e]||[]).slice();t.push(s),a(q,{...n(q),[e]:t.slice(-1e3)},!0),bt(e)}async function At(e,s){let t=n(o).find(i=>i.id===e);if(t)for(;;){const i=new AbortController;O[e]=i;let r;try{r=await R.openScanEvents(s,{signal:i.signal})}catch(l){console.error("Scan events probe failed",l);return}if(String(r.headers?.get("content-type")||"").toLowerCase().includes("text/event-stream")){i.abort(),delete O[e];const l=R.openScanEventsSSE(s);_[e]=l;const S=P=>{try{if(t=n(o).find(u=>u.id===e)||t,!t)return;const p=JSON.parse(String(P.data||"{}"));t.progress.finished=Number(p.finished??t.progress.finished),t.progress.total=Number(p.total??t.progress.total);const c=Math.floor((Number(p.finished??t.progress.finished)||0)/Math.max(1,Number(p.total??t.progress.total))*100);t.progress.percent=Number(p.percent??c),t.progress.rate=Number(p.rate??t.progress.rate),t.progress.elapsedMs=Number(p.elapsedMs??t.progress.elapsedMs),a(o,n(o).map(u=>u.id===e?t:u),!0)}catch{}},M=P=>{try{if(t=n(o).find(u=>u.id===e)||t,!t)return;const p=JSON.parse(String(P.data||"{}")),c=String(p.status||"").toLowerCase();if(c){const u=t.status;if(t.status=["starting","running","paused","completed","failed","cancelled"].includes(c)?c:t.status,t.status==="completed"&&(t.progress.percent=100,t.progress.total>0&&(t.progress.finished=t.progress.total)),c==="paused"&&(t.status="paused"),a(o,n(o).map(v=>v.id===e?t:v),!0),u!==t.status&&N(),c==="completed"||c==="failed"||c==="cancelled"){try{O[e]?.abort()}catch{}_[e]?.close(),delete _[e],delete O[e]}}}catch{}},J=P=>{try{if(t=n(o).find(v=>v.id===e)||t,!t)return;const p=JSON.parse(String(P.data||"{}")),c=String(p.severity||"info");t.severityStats[c]=(t.severityStats[c]||0)+1;const u=(t.progress.hits||0)+1;x(e,{ts:Date.now(),type:"hit",text:String(p.message||"命中"),severity:c,pocName:String(p.poc?.name||t.poc?.name||""),url:String(p.target||t.target||""),label:"HTTP",seq:u}),K(e,{ts:Date.now(),severity:c,target:String(p.target||t.target||""),pocId:String(p.poc?.id||t.poc?.id||""),pocName:String(p.poc?.name||t.poc?.name||""),message:String(p.message||"命中"),seq:u}),t.progress.hits=u,a(o,n(o).map(v=>v.id===e?t:v),!0)}catch{}};l.addEventListener("progress",S),l.addEventListener("status",M),l.addEventListener("result",J),l.onerror=()=>{try{_[e]?.close()}catch{}delete _[e],setTimeout(async()=>{t=n(o).find(P=>P.id===e)||t,t&&!["completed","failed","cancelled"].includes(t.status)&&At(e,s)},1500)};return}const h=r.body?.getReader();if(!h){await tt(1e3);continue}const T=new TextDecoder;let y="",b=!1;const L=()=>{let l=0,S=0,M=-1;for(;l<y.length;){const J=y[l];if(J==="{")S===0&&(M=l),S++;else if(J==="}"&&(S--,S===0&&M>=0)){const P=y.slice(M,l+1).trim();try{const p=JSON.parse(P);if(p&&(p.percent!==void 0||p.finished!==void 0||p.total!==void 0)){if(t=n(o).find(v=>v.id===e)||t,!t)return;const c=p||{};t.progress.finished=Number(c.finished??t.progress.finished),t.progress.total=Number(c.total??t.progress.total);const u=Math.floor((Number(c.finished??t.progress.finished)||0)/Math.max(1,Number(c.total??t.progress.total))*100);t.progress.percent=Number(c.percent??u),t.progress.rate=Number(c.rate??t.progress.rate),t.progress.elapsedMs=Number(c.elapsedMs??t.progress.elapsedMs),a(o,n(o).map(v=>v.id===e?t:v),!0)}else if(p&&(p.severity!==void 0||p.poc!==void 0||p.target!==void 0)){if(t=n(o).find(C=>C.id===e)||t,!t)return;const c=p||{},u=String(c.severity||"info");t.severityStats[u]=(t.severityStats[u]||0)+1;const v=(t.progress.hits||0)+1;x(e,{ts:Date.now(),type:"hit",text:String(c.message||"命中"),severity:u,pocName:String(c.poc?.name||t.poc?.name||""),url:String(c.target||t.target||""),label:"HTTP",seq:v}),K(e,{ts:Date.now(),severity:u,target:String(c.target||t.target||""),pocId:String(c.poc?.id||t.poc?.id||""),pocName:String(c.poc?.name||t.poc?.name||""),message:String(c.message||"命中"),seq:v}),t.progress.hits=v,a(o,n(o).map(C=>C.id===e?t:C),!0)}else if(p&&p.status!==void 0){if(t=n(o).find(v=>v.id===e)||t,!t)return;const u=String((p||{}).status||"").toLowerCase();if(u){const v=t.status;if(t.status=["starting","running","paused","completed","failed","cancelled"].includes(u)?u:t.status,t.status==="completed"&&(t.progress.percent=100,t.progress.total>0&&(t.progress.finished=t.progress.total)),a(o,n(o).map(C=>C.id===e?t:C),!0),v!==t.status&&N(),u==="completed"||u==="failed"||u==="cancelled"){try{O[e]?.abort()}catch{}delete O[e]}}}else if(p&&p.error!==void 0){if(t=n(o).find(u=>u.id===e)||t,!t)return;const c=p||{};x(e,{ts:Date.now(),type:"error",text:String(c.message||"")}),t.status="failed",a(o,n(o).map(u=>u.id===e?t:u),!0),N()}}catch{}y=y.slice(l+1),l=-1,M=-1,S=0}l++}};for(;;){const{value:l,done:S}=await h.read();if(S){b=!0;break}y+=T.decode(l,{stream:!0}),L()}if(["completed","failed","cancelled"].includes(t.status))break;if(b){let l=null;try{const S=await R.getScanStatus(s);l=String(S?.data?.status||"")}catch{}if(l==="completed"||l==="failed"||l==="cancelled"){t.status=l||t.status,t.status==="completed"&&(t.progress.percent=100,t.progress.total>0&&(t.progress.finished=t.progress.total)),a(o,n(o).map(S=>S.id===e?t:S),!0),N();break}await tt(1500);continue}break}}const fe={get expanded(){return n(X)},get panelSnap(){return n(vt)},get tasks(){return n(o)},get activeTask(){return Zt()},get logs(){return n(A)},get hits(){return n(q)},get runningCount(){return n(o).filter(e=>e.status==="running"||e.status==="starting"||e.status==="paused").length},get defaultOptions(){return D},setPanelExpanded:Qt,setPanelSnap:Yt,createTask:Xt,begin:Nt,pause:It,resume:kt,cancel:wt,removeTask:te,setActiveTask:ee,setTaskOptions:re,setTaskPoc:se,addTaskPoc:ne,removeTaskPoc:oe,clearTaskPocs:ie,setGlobalOptions:ae,appendLog:x,appendHit:K,restore:Kt};export{pe as P,le as R,ft as a,fe as s};
