name: ðŸŽ‰ Release Binary

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run snapshot build without publishing"
        type: boolean
        default: true
        required: false
      ref:
        description: "Git ref to test (branch or commit SHA)"
        type: string
        default: ""
        required: false

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      GOPROXY: https://proxy.golang.org,direct
      GOSUMDB: sum.golang.org

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.ref }}

      - uses: actions/setup-go@v4
        with:
          go-version: 1.24.1
          cache: true

      - name: Verify embedded web assets
        run: |
          set -euo pipefail
          ls -la pkg/web/webpath || (echo "missing webpath directory" && exit 1)
          test -f pkg/web/webpath/index.html || (echo "missing index.html" && exit 1)
          test -d pkg/web/webpath/_app/immutable/entry || (echo "missing entry directory" && exit 1)
          ENTRY_COUNT=$(find pkg/web/webpath/_app/immutable/entry -maxdepth 1 -type f -name '*.js' | wc -l || echo 0)
          [ "$ENTRY_COUNT" -gt 0 ] || (echo "missing entry js" && exit 1)
          CHUNKS=$(ls pkg/web/webpath/_app/immutable/chunks/*.js | wc -l)
          [ "$CHUNKS" -gt 0 ] || (echo "missing chunks js" && exit 1)

      - name: Detect unmatched web assets (embed coverage guard)
        run: |
          set -euo pipefail
          TOP_EXTS='html|ico|png|svg|webmanifest|json|txt'
          ALLOWED_TOP_RE="^pkg/web/webpath/[^/]+\.(${TOP_EXTS})$"
          ALLOWED_DIRS_RE='^pkg/web/webpath/(fonts/.+|_app/.+|docs/.+|pocs/.+|reports/.+)$'
          UNMATCHED=$(find pkg/web/webpath -type f | grep -v -E "$ALLOWED_TOP_RE" | grep -v -E "$ALLOWED_DIRS_RE" | grep -v -E "/\.DS_Store$" || true)
          if [ -n "$UNMATCHED" ]; then
            echo "[embed coverage] Detected files not covered by go:embed patterns:" >&2
            echo "$UNMATCHED" >&2
            echo "Please update pkg/web/embed.go to include these paths." >&2
            exit 1
          fi

      - name: Go modules download
        run: |
          set -euo pipefail
          go mod download

      - name: Smoke build (validate go:embed)
        env:
          CGO_ENABLED: 0
        run: |
          go build -trimpath -ldflags "-s -w" -o ./_afrog_smoke ./cmd/afrog
          file ./_afrog_smoke || true

      - name: Web smoke test (-web mode assets)
        env:
          CGO_ENABLED: 0
        run: |
          set -euo pipefail
          ./_afrog_smoke -web >/dev/null 2>&1 & echo $! > _afrog_pid
          trap 'kill "$(cat _afrog_pid)" 2>/dev/null || true' EXIT
          for i in $(seq 1 15); do
            if curl -fsS http://127.0.0.1:16868/api/health | grep -q '"status":"ok"'; then
              break
            fi
            sleep 1
          done
          curl -fsS -I http://127.0.0.1:16868/ | grep -E "HTTP/.* 200" >/dev/null
          curl -fsS -I http://127.0.0.1:16868/ | grep -i "Content-Type: text/html" >/dev/null
          APPJS=$(ls pkg/web/webpath/_app/immutable/entry/*app*.js 2>/dev/null | head -n1 || true)
          if [ -z "$APPJS" ]; then APPJS=$(ls pkg/web/webpath/_app/immutable/entry/*.js | head -n1 || true); fi
          APPURL=$(echo "$APPJS" | sed 's#pkg/web/webpath##')
          if [ -n "$APPURL" ]; then
            curl -fsS -I "http://127.0.0.1:16868$APPURL" | grep -E "HTTP/.* 200" >/dev/null
            curl -fsS -I "http://127.0.0.1:16868$APPURL" | grep -i "Content-Type: application/javascript\|Content-Type: text/javascript" >/dev/null
          fi
          STARTJS=$(ls pkg/web/webpath/_app/immutable/entry/*start*.js 2>/dev/null | head -n1 || true)
          if [ -z "$STARTJS" ]; then STARTJS=$(ls pkg/web/webpath/_app/immutable/entry/*.js | head -n1 || true); fi
          STARTURL=$(echo "$STARTJS" | sed 's#pkg/web/webpath##')
          curl -fsS -I "http://127.0.0.1:16868$STARTURL" | grep -E "HTTP/.* 200" >/dev/null
          curl -fsS -I "http://127.0.0.1:16868$STARTURL" | grep -i "Content-Type: application/javascript\|Content-Type: text/javascript" >/dev/null
          ASSETCSS=$(ls pkg/web/webpath/_app/immutable/assets/*.css | head -n1 || true)
          if [ -n "$ASSETCSS" ]; then
            CSSURL=$(echo "$ASSETCSS" | sed 's#pkg/web/webpath##')
            curl -fsS -I "http://127.0.0.1:16868$CSSURL" | grep -E "HTTP/.* 200" >/dev/null
            curl -fsS -I "http://127.0.0.1:16868$CSSURL" | grep -i "Content-Type: text/css" >/dev/null
          fi

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: afrog-smoke-debug
          path: |
            _afrog_smoke
            _afrog_pid

      - name: Goreleaser snapshot (no publish)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
        uses: goreleaser/goreleaser-action@v4
        with:
          args: "release --clean --skip-publish --snapshot"
          version: latest
          workdir: .
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Upload snapshot artifacts
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: afrog-dist-snapshot
          path: |
            dist/**

      - name: Goreleaser publish
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true')
        uses: goreleaser/goreleaser-action@v4
        with:
          args: "release --clean"
          version: latest
          workdir: .
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
